{{!-- Custom SimpleLogin Button Section --}}
<div class="custom-social-login">
    <button type="button" class="sl-custom-btn" onclick="redirectToSimpleLogin()">
        <img src="https://simplelogin.io/press/logo.svg" 
             width="20" 
             style="margin-right:10px;"
             alt="SimpleLogin logo">
        Sign in with SimpleLogin
    </button>
</div>

<div id="login">
  {{{card}}}
  {{> js_setup nodes=nodes}}
  {{#if extraPartial}}
    {{> (extraPartial)}}
  {{/if}}
</div>

<style>
.custom-social-login {
    margin-bottom: 20px;
    padding: 0 8px;
}
.sl-custom-btn {
    background-color: #2c3e50;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    cursor: pointer;
    font-weight: 600;
    width: 100%;
    justify-content: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: background 0.2s ease;
}
.sl-custom-btn:hover {
    background-color: #1a252f;
}

/* Prevent double-click issues */
.sl-custom-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
}
</style>

<script>
function redirectToSimpleLogin() {
    const urlParams = new URLSearchParams(window.location.search);
    const flowId = urlParams.get('flow');
    const returnTo = urlParams.get('return_to');
    const kratosUrl = "https://gateway-production-7363.up.railway.app";

    // Prevent double clicks
    const btn = document.querySelector('.sl-custom-btn');
    if (btn) btn.disabled = true;

    // Build return_to param if present
    const returnToParam = returnTo 
        ? `&return_to=${encodeURIComponent(returnTo)}` 
        : '';

    if (!flowId) {
        // No flow yet - initiate a new login flow with SimpleLogin directly
        window.location.href = `${kratosUrl}/self-service/login/browser?provider=simplelogin${returnToParam}`;
        return;
    }

    // Flow exists - redirect to OIDC auth with correct path
    window.location.href = `${kratosUrl}/self-service/login/methods/oidc/auth/${flowId}?provider=simplelogin${returnToParam}`;
}
</script>